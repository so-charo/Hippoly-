<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <!-- iPadのダブルタップ拡大を抑止。ユーザー拡大なし -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>図形ボード（iPad最適・方眼吸着強化）</title>
  <style>
    /* ========== テーマ（ライト/ダーク） ========== */
    :root{
      /* 基本 */
      --page-bg:#f7fafc;
      --text:#111827;
      --panel-bg:#ffffff;
      --panel-shadow:0 10px 30px rgba(0,0,0,.06);
      --accent:#2563eb;
      --soft:#e5e7eb;

      /* ボタン */
      --btn-bg:#ffffff;
      --btn-border:#e5e7eb;
      --btn-active:#dbeafe;
      --btn-hover-shadow:0 1px 3px rgba(0,0,0,.06);
      --btn-focus:#93c5fd;

      /* 方眼 */
      --grid-cm:37.7952755906; /* 96dpi前提 1cm ≒ 37.795px */
      --grid-stroke:#bfdbfe;   /* 薄水色 */
      --grid-pt:1.0;           /* 1px */

      /* 付箋色 */
      --note-yellow:#fffbe6;
      --note-blue:#e6f3ff;
      --note-pink:#ffeaf1;

      /* バッジ/ヘルプ */
      --badge-bg:#eef2ff;
      --badge-border:#c7d2fe;
      --badge-text:#1e3a8a;
      --hint:#6b7280;

      /* サイドバー */
      --aside-width:320px;
    }

    [data-theme="dark"]{
      --page-bg:#0f172a;
      --text:#e5e7eb;
      --panel-bg:#111827;
      --panel-shadow:0 10px 30px rgba(0,0,0,.35);

      --btn-bg:#1f2937;
      --btn-border:#334155;
      --btn-active:#1d4ed8;
      --btn-hover-shadow:0 1px 3px rgba(255,255,255,.06);
      --btn-focus:#60a5fa;

      --grid-stroke:#334155;
      --grid-pt:1.0;

      --note-yellow:#5b5b3a;
      --note-blue:#334e68;
      --note-pink:#6e3948;

      --badge-bg:#1f2937;
      --badge-border:#374151;
      --badge-text:#dbeafe;
      --hint:#94a3b8;
    }

    html,body{height:100%;}
    /* ページスクロール禁止。中の領域で完結 */
    html,body{overflow:hidden;}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
      background:var(--page-bg); color:var(--text); display:grid; grid-template-rows:auto 1fr;
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none;
      -webkit-tap-highlight-color: transparent;
    }
    header{
      background:var(--panel-bg); color:var(--text);
      padding:10px 12px; box-shadow:0 2px 10px rgba(0,0,0,.06); position:sticky; top:0; z-index:10;
    }
    header .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    header .title{font-weight:700;}
    select, input[type="color"], button, label.toggle{
      border:1px solid var(--btn-border); background:var(--btn-bg); color:var(--text);
      border-radius:10px; padding:10px 12px; font-size:14px;
      transition: box-shadow .12s ease, background .12s ease, transform .04s ease;
    }
    button{cursor:pointer;}
    button:hover{ box-shadow: var(--btn-hover-shadow); }
    button:active{ transform: translateY(0.5px); }
    button:focus-visible{ outline: 2px solid var(--btn-focus); outline-offset: 2px; }
    button:disabled{opacity:.5; cursor:not-allowed;}
    .active{background:var(--btn-active)!important; color:#fff; }

    main{
      display:grid; grid-template-columns:1fr var(--aside-width); gap:12px; padding:12px;
      transition: grid-template-columns .15s ease;
      align-items:stretch;
    }

    aside{
      order:2; background:var(--panel-bg); color:var(--text); border-radius:14px;
      padding:12px; box-shadow: var(--panel-shadow); overflow:hidden; position:relative;
      display:flex; flex-direction:column;
    }
    .aside-head{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;
    }
    /* 左上に折りたたみタブ */
    #asideTab{
      position:absolute; left:-18px; top:12px;
      width:18px; height:40px; border-radius:8px 0 0 8px;
      background:var(--btn-bg); border:1px solid var(--btn-border);
      display:flex; align-items:center; justify-content:center;
      font-size:12px; cursor:pointer;
    }
    body.aside-collapsed main{ grid-template-columns:1fr 0px; }
    body.aside-collapsed aside{ width:0; padding:0; border:none; opacity:0; pointer-events:none; }
    body.aside-collapsed #asideTab{ display:none; }
    #boardWrap{
      order:1; position:relative; overflow:hidden; border-radius:14px;
      background:var(--panel-bg); box-shadow: var(--panel-shadow);
      display:flex; align-items:center; justify-content:center;
    }
    #board{
      width:100%; height:100%; position:relative;
      touch-action:none; /* iPadでの勝手なズームやスクロール禁止 */
    }
    svg, canvas{
      position:absolute; top:0; left:0; width:100%; height:100%;
      touch-action:none;
    }

    #notesLayer{ position:absolute; top:0; left:0; right:0; bottom:0; pointer-events:none; }
    .note{
      position:absolute; resize:both; min-width:100px; min-height:100px;
      background:var(--note-yellow); color:var(--text);
      padding:4px; border:1px solid var(--btn-border); border-radius:6px;
      box-sizing:border-box; overflow:auto;
      pointer-events:auto;
      font-size:13pt;
    }

    /* カーソルのゴースト円 */
    #cursorCanvas{ pointer-events:none; }

  </style>
</head>
<body>
  <header>
    <div class="row">
      <span class="title">図形ボード</span>
      <button id="themeToggle">🌙</button>
      <select id="gridSize">
        <option value="3">3cm</option>
      </select>
      <select id="penColor"></select>
      <button id="undo">Undo</button>
      <button id="redo">Redo</button>
      <button id="save">保存</button>
      <button id="load">読込</button>
      <button id="reset">リセット</button>
    </div>
  </header>
  <main>
    <div id="boardWrap">
      <div id="board">
        <svg id="gridLayer"></svg>
        <svg id="shapesLayer"></svg>
        <svg id="handlesLayer"></svg>
        <canvas id="drawCanvas"></canvas>
        <canvas id="cursorCanvas"></canvas>
        <div id="notesLayer"></div>
      </div>
    </div>
    <aside id="aside">
      <div id="asideTab">▶</div>
      <div class="aside-head">ツール</div>
      <div id="toolbar">
        <button id="modeSelect">選択</button>
        <button id="modeDraw">ペン</button>
        <button id="modeErase">消し</button>
        <button id="modeNote">付箋</button>
        <button id="modeCut">カット</button>
        <button id="modeRect">長方形</button>
        <button id="modeTri">三角形</button>
        <button id="modePara">平行四辺形</button>
        <button id="modeTrap">台形</button>
        <button id="modeRhomb">ひし形</button>
      </div>
    </aside>
  </main>
  <script>
'use strict';
const state={
  gridCm:3,
  gridPx:Math.round(37.795*3),
  dpr:1,
  shapes:[],
  notes:[],
  timeline:[],
  penColor:'#000000',
  undoStack:[],
  redoStack:[],
  snapTol:12,
  mode:'select'
};
const ui={
  gridLayer:document.getElementById('gridLayer'),
  shapesLayer:document.getElementById('shapesLayer'),
  handlesLayer:document.getElementById('handlesLayer'),
  drawCanvas:document.getElementById('drawCanvas'),
  cursorCanvas:document.getElementById('cursorCanvas'),
  notesLayer:document.getElementById('notesLayer'),
  aside:document.getElementById('aside'),
  asideTab:document.getElementById('asideTab'),
  penColor:document.getElementById('penColor'),
  themeToggle:document.getElementById('themeToggle')
};
// ========= ペンパレット（テーマ連動） =========
function applyPenPalette(theme){
  // option削除
  while(ui.penColor.firstChild) ui.penColor.removeChild(ui.penColor.firstChild);

  const palette = (theme==='dark')
    ? [
      {label:'白', value:'#ffffff'},
      {label:'薄橙', value:'#ffb347'},
      {label:'水色', value:'#87cefa'},
      {label:'黄緑', value:'#90ee90'}
    ]
    : [
      {label:'黒', value:'#1f2937'},
      {label:'赤', value:'#ef4444'},
      {label:'青', value:'#2563eb'},
      {label:'緑', value:'#16a34a'}
    ];
  for(const c of palette){
    const opt=document.createElement('option');
    opt.value=c.value; opt.textContent=c.label;
    ui.penColor.appendChild(opt);
  }
}

ui.penColor.addEventListener('change', ()=>{
  state.penColor = ui.penColor.value;
});

// ========= テーマ適用 =========
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  ui.themeToggle.textContent = (theme==='dark') ? '☀️' : '🌙';
  localStorage.setItem('board-theme', theme);

  applyPenPalette(theme);

  // stateとUI同期
  const opts = Array.from(ui.penColor.options).map(o=>o.value);
  if(!opts.includes(state.penColor)){
    state.penColor = opts[0] || (theme==='dark' ? '#ffffff' : '#1f2937');
  }
  ui.penColor.value = state.penColor;

  drawGrid();
  render();
  redrawCanvas();
  redrawCursorOverlay();
}

// ========= レイアウト調整 =========
function ensureLayout(){
  const W = document.getElementById('board').clientWidth;
  const H = document.getElementById('board').clientHeight;
  [ui.gridLayer,ui.shapesLayer,ui.handlesLayer].forEach(el=>{
    el.setAttribute('width',W);
    el.setAttribute('height',H);
  });
  [ui.drawCanvas, ui.cursorCanvas].forEach(cv=>{
    cv.width = W*state.dpr;
    cv.height = H*state.dpr;
    cv.style.width = W+'px';
    cv.style.height = H+'px';
    const ctx=cv.getContext('2d');
    ctx.setTransform(state.dpr,0,0,state.dpr,0,0);
  });
}

// ========= グリッド描画 =========
function drawGrid(){
  const W=ui.gridLayer.clientWidth, H=ui.gridLayer.clientHeight;
  ui.gridLayer.innerHTML='';
  const g = state.gridPx;
  for(let x=0;x<=W;x+=g){
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',x); line.setAttribute('y1',0);
    line.setAttribute('x2',x); line.setAttribute('y2',H);
    line.setAttribute('stroke','var(--grid-stroke)');
    line.setAttribute('stroke-width','1');
    ui.gridLayer.appendChild(line);
  }
  for(let y=0;y<=H;y+=g){
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',0); line.setAttribute('y1',y);
    line.setAttribute('x2',W); line.setAttribute('y2',y);
    line.setAttribute('stroke','var(--grid-stroke)');
    line.setAttribute('stroke-width','1');
    ui.gridLayer.appendChild(line);
  }
}

// ========= Boot =========
function boot(){
  state.dpr = window.devicePixelRatio||1;
  ensureLayout();

  // 起動時は3cm固定
  state.gridPx = Math.round(37.795*3);
  document.getElementById('gridSize').value='3';

  const saved = localStorage.getItem('board-theme');
  const theme = saved ? saved : ((window.matchMedia('(prefers-color-scheme: dark)').matches)?'dark':'light');
  applyTheme(theme);

  // 初期描画
  drawGrid(); render(); redrawCanvas(); redrawCursorOverlay();

  window.addEventListener('resize', ()=>{
    ensureLayout();
    drawGrid(); render(); redrawCanvas(); redrawCursorOverlay();
  });
}

// ========= ダミー関数群 =========
function render(){}
function redrawCanvas(){}
function redrawCursorOverlay(){}

// ========= 起動 =========
window.addEventListener('load', boot);
  </script>
</body>
</html>

	  
