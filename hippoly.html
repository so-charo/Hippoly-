<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <!-- iPadã§ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ã‚„é•·æŠ¼ã—é¸æŠã‚’é˜²æ­¢ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>å›³å½¢ãƒœãƒ¼ãƒ‰ï¼ˆiPadæœ€é©ãƒ»æ–¹çœ¼å¸ç€å¼·åŒ–ï¼‰</title>
  <style>
    :root{
      --page-bg:#f7fafc;
      --text:#111827;
      --panel-bg:#ffffff;
      --panel-shadow:0 10px 30px rgba(0,0,0,.06);
      --accent:#2563eb;
      --soft:#e5e7eb;
      --btn-bg:#ffffff;
      --btn-border:#e5e7eb;
      --btn-active:#dbeafe;
      --btn-hover-shadow:0 1px 3px rgba(0,0,0,.06);
      --btn-focus:#93c5fd;
      --grid-cm:37.7952755906;
      --grid-stroke:#bfdbfe;
      --note-yellow:#fffbe6;
      --note-blue:#e6f3ff;
      --note-pink:#ffeaf1;
      --badge-bg:#eef2ff;
      --badge-border:#c7d2fe;
      --badge-text:#1e3a8a;
      --hint:#6b7280;
      --aside-width:320px;
    }
    [data-theme="dark"]{
      --page-bg:#0f172a;
      --text:#e5e7eb;
      --panel-bg:#111827;
      --panel-shadow:0 10px 30px rgba(0,0,0,.35);
      --btn-bg:#1f2937;
      --btn-border:#334155;
      --btn-active:#1d4ed8;
      --btn-hover-shadow:0 1px 3px rgba(255,255,255,.06);
      --btn-focus:#60a5fa;
      --grid-stroke:#334155;
      --note-yellow:#5b5b3a;
      --note-blue:#334e68;
      --note-pink:#6e3948;
      --badge-bg:#1f2937;
      --badge-border:#374151;
      --badge-text:#dbeafe;
      --hint:#94a3b8;
    }
    html,body{height:100%;overflow:hidden;margin:0;font-family:sans-serif;background:var(--page-bg);color:var(--text);}
    header{
      background:var(--panel-bg);color:var(--text);
      padding:10px 12px;box-shadow:0 2px 10px rgba(0,0,0,.06);z-index:10;
    }
    header .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
    main{display:grid;grid-template-columns:1fr var(--aside-width);gap:12px;padding:12px;align-items:stretch;}
    aside{background:var(--panel-bg);color:var(--text);border-radius:14px;padding:12px;box-shadow:var(--panel-shadow);position:relative;}
    #asideTab{position:absolute;left:-18px;top:12px;width:18px;height:40px;border-radius:8px 0 0 8px;background:var(--btn-bg);border:1px solid var(--btn-border);display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;}
    body.aside-collapsed main{grid-template-columns:1fr 0;}
    body.aside-collapsed aside{width:0;padding:0;opacity:0;pointer-events:none;}
    #boardWrap{position:relative;overflow:hidden;border-radius:14px;background:var(--panel-bg);box-shadow:var(--panel-shadow);}
    #board{width:100%;height:100%;position:relative;touch-action:none;}
    svg,canvas{position:absolute;top:0;left:0;width:100%;height:100%;touch-action:none;}
    #notesLayer{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;}
    .note{position:absolute;resize:both;min-width:100px;min-height:100px;background:var(--note-yellow);color:var(--text);padding:4px;border:1px solid var(--btn-border);border-radius:6px;box-sizing:border-box;overflow:auto;pointer-events:auto;font-size:13pt;}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <span class="title">å›³å½¢ãƒœãƒ¼ãƒ‰</span>
      <button id="themeToggle">ğŸŒ™</button>
      <select id="gridSize">
        <option value="3">3cm</option>
      </select>
      <select id="penColor"></select>
      <button id="undo">Undo</button>
      <button id="redo">Redo</button>
      <button id="save">ä¿å­˜</button>
      <button id="load">èª­è¾¼</button>
      <button id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </header>
  <main>
    <div id="boardWrap">
      <div id="board">
        <svg id="gridLayer"></svg>
        <svg id="shapesLayer"></svg>
        <svg id="handlesLayer"></svg>
        <canvas id="drawCanvas"></canvas>
        <canvas id="cursorCanvas"></canvas>
        <div id="notesLayer"></div>
      </div>
    </div>
    <aside id="aside">
      <div id="asideTab">â–¶</div>
      <div id="toolbar">
        <button id="modeSelect">é¸æŠ</button>
        <button id="modeDraw">ãƒšãƒ³</button>
        <button id="modeErase">æ¶ˆã—</button>
        <button id="modeNote">ä»˜ç®‹</button>
        <button id="modeCut">ã‚«ãƒƒãƒˆ</button>
        <button id="modeRect">é•·æ–¹å½¢</button>
        <button id="modeTri">ä¸‰è§’å½¢</button>
        <button id="modePara">å¹³è¡Œå››è¾ºå½¢</button>
        <button id="modeTrap">å°å½¢</button>
        <button id="modeRhomb">ã²ã—å½¢</button>
      </div>
    </aside>
  </main>
  <script>
'use strict';
const state={
  gridCm:3,
  gridPx:Math.round(37.795*3),
  dpr:1,
  shapes:[],
  notes:[],
  timeline:[],
  penColor:'#000000',
  undoStack:[],
  redoStack:[],
  snapTol:12,
  mode:'select'
};
const ui={
  gridLayer:document.getElementById('gridLayer'),
  shapesLayer:document.getElementById('shapesLayer'),
  handlesLayer:document.getElementById('handlesLayer'),
  drawCanvas:document.getElementById('drawCanvas'),
  cursorCanvas:document.getElementById('cursorCanvas'),
  notesLayer:document.getElementById('notesLayer'),
  aside:document.getElementById('aside'),
  asideTab:document.getElementById('asideTab'),
  penColor:document.getElementById('penColor'),
  themeToggle:document.getElementById('themeToggle')
};

// ===== ãƒšãƒ³ãƒ‘ãƒ¬ãƒƒãƒˆ =====
function applyPenPalette(theme){
  while(ui.penColor.firstChild) ui.penColor.removeChild(ui.penColor.firstChild);
  const palette = (theme==='dark')
    ? [
      {label:'ç™½', value:'#ffffff'},
      {label:'è–„æ©™', value:'#ffb347'},
      {label:'æ°´è‰²', value:'#87cefa'},
      {label:'é»„ç·‘', value:'#90ee90'}
    ]
    : [
      {label:'é»’', value:'#1f2937'},
      {label:'èµ¤', value:'#ef4444'},
      {label:'é’', value:'#2563eb'},
      {label:'ç·‘', value:'#16a34a'}
    ];
  for(const c of palette){
    const opt=document.createElement('option');
    opt.value=c.value; opt.textContent=c.label;
    ui.penColor.appendChild(opt);
  }
}
ui.penColor.addEventListener('change', ()=>{ state.penColor = ui.penColor.value; });

// ===== ãƒ†ãƒ¼ãƒé©ç”¨ =====
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  ui.themeToggle.textContent = (theme==='dark') ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('board-theme', theme);

  applyPenPalette(theme);

  const opts = Array.from(ui.penColor.options).map(o=>o.value);
  if(!opts.includes(state.penColor)){
    state.penColor = opts[0] || (theme==='dark' ? '#ffffff' : '#1f2937');
  }
  ui.penColor.value = state.penColor;

  drawGrid();
  render();
  redrawCanvas();
  redrawCursorOverlay();
}

// ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ =====
function ensureLayout(){
  const W = document.getElementById('board').clientWidth;
  const H = document.getElementById('board').clientHeight;
  [ui.gridLayer,ui.shapesLayer,ui.handlesLayer].forEach(el=>{
    el.setAttribute('width',W);
    el.setAttribute('height',H);
  });
  [ui.drawCanvas, ui.cursorCanvas].forEach(cv=>{
    cv.width = W*state.dpr;
    cv.height = H*state.dpr;
    cv.style.width = W+'px';
    cv.style.height = H+'px';
    const ctx=cv.getContext('2d');
    ctx.setTransform(state.dpr,0,0,state.dpr,0,0);
  });
}

// ===== ã‚°ãƒªãƒƒãƒ‰æç”» =====
function drawGrid(){
  const W=ui.gridLayer.clientWidth, H=ui.gridLayer.clientHeight;
  ui.gridLayer.innerHTML='';
  const g = state.gridPx;
  for(let x=0;x<=W;x+=g){
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',x); line.setAttribute('y1',0);
    line.setAttribute('x2',x); line.setAttribute('y2',H);
    line.setAttribute('stroke','var(--grid-stroke)');
    line.setAttribute('stroke-width','1');
    ui.gridLayer.appendChild(line);
  }
  for(let y=0;y<=H;y+=g){
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',0); line.setAttribute('y1',y);
    line.setAttribute('x2',W); line.setAttribute('y2',y);
    line.setAttribute('stroke','var(--grid-stroke)');
    line.setAttribute('stroke-width','1');
    ui.gridLayer.appendChild(line);
  }
}

// ===== Boot =====
function boot(){
  state.dpr = window.devicePixelRatio||1;
  ensureLayout();

  state.gridPx = Math.round(37.795*3);
  document.getElementById('gridSize').value='3';

  const saved = localStorage.getItem('board-theme');
  const theme = saved ? saved : ((window.matchMedia('(prefers-color-scheme: dark)').matches)?'dark':'light');
  applyTheme(theme);

  // åˆæœŸæç”»
  drawGrid(); render(); redrawCanvas(); redrawCursorOverlay();

  window.addEventListener('resize', ()=>{
    ensureLayout();
    drawGrid(); render(); redrawCanvas(); redrawCursorOverlay();
  });
}

// ===== ãƒ€ãƒŸãƒ¼é–¢æ•° =====
function render(){}
function redrawCanvas(){}
function redrawCursorOverlay(){}

// ===== èµ·å‹• =====
window.addEventListener('load', boot);
  </script>
</body>
</html>
