<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>Hippoly!</title>
<style>
:root{
  --page-bg:#f7fafc;
  --text:#111827;
  --panel-bg:#ffffff;
  --panel-shadow:0 8px 24px rgba(0,0,0,.05);
  --accent:#2563eb;
  --soft:#e5e7eb;
  --btn-bg:#fff;
  --btn-border:#d1d5db;
  --btn-hover-shadow:0 1px 2px rgba(0,0,0,.08);
  --btn-active:#e0e7ff;
  --aside-width:320px;
  --asideB-width:220px;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans JP',sans-serif;
  font-size:11pt;
}

/* ÂÖ®‰Ωì„É¨„Ç§„Ç¢„Ç¶„Éà */
html,body{margin:0;height:100%;background:var(--page-bg);color:var(--text);overflow:hidden;}
main{
  display:grid;
  grid-template-columns: var(--asideB-width) 1fr var(--aside-width);
  height:100vh;
}
body.aside-collapsed main{grid-template-columns: var(--asideB-width) 1fr 0;}
body.asideB-collapsed main{grid-template-columns: 0 1fr var(--aside-width);}
body.swap-sidebars main{grid-template-columns: var(--aside-width) 1fr var(--asideB-width);}

/* „Éò„ÉÉ„ÉÄ */
header{
  display:flex;align-items:center;justify-content:center;
  padding:4px 10px;gap:10px;position:relative;
  border-bottom:1px solid var(--soft);background:var(--panel-bg);
}
header .title{
  position:absolute;left:12px;font-weight:bold;font-size:1.1rem;
}
header button,header select{
  font-size:11pt;border:1px solid var(--btn-border);border-radius:6px;
  padding:2px 6px;background:var(--btn-bg);cursor:pointer;
}
header .mid{display:flex;align-items:center;gap:6px;}

/* ===== Â∑¶„ÉÑ„Éº„É´„Éê„ÉºÔºà„Çµ„É†„Éç‰∏ÄË¶ßÔºâ ===== */
.asideB{
  order:0;
  background:var(--panel-bg);
  color:var(--text);
  border-right:1px solid var(--soft);
  width:var(--asideB-width);
  box-shadow:var(--panel-shadow);
  position:relative;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
body.asideB-collapsed .asideB{width:0;padding:0;border:none;}
.asideB-tab{
  position:absolute;right:-22px;top:10px;width:22px;height:40px;
  display:flex;align-items:center;justify-content:center;
  background:var(--btn-bg);border:1px solid var(--btn-border);
  border-radius:0 6px 6px 0;
  cursor:pointer;box-shadow:var(--btn-hover-shadow);
  z-index:1000;
}
.asideB .panel-title{font-size:12px;margin:6px 0;}
.asideB-buttons{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px;}
#thumbList{
  flex:1;overflow:auto;display:flex;flex-direction:column;gap:6px;
}
.thumb{
  position:relative;border:1px solid var(--btn-border);
  border-radius:6px;overflow:hidden;cursor:grab;background:#fff;
}
.thumb img{display:block;width:100%;height:100px;object-fit:cover;}
.thumb .cap{
  position:absolute;left:4px;top:4px;
  background:rgba(0,0,0,.5);color:#fff;font-size:10px;
  padding:1px 5px;border-radius:5px;
}
.thumb .del{
  position:absolute;right:4px;top:4px;background:#f87171;
  color:#fff;border:none;border-radius:4px;width:18px;height:18px;
  font-size:12px;line-height:16px;cursor:pointer;
}
.thumb.dragging{opacity:.6;}
.saveAllWrap{
  border-top:1px dashed var(--soft);
  padding:6px;text-align:center;
}
.saveAllWrap button{
  font-size:11pt;width:100%;
}

/* ===== Âè≥„ÉÑ„Éº„É´„Éê„Éº ===== */
aside{
  order:2;
  background:var(--panel-bg);
  color:var(--text);
  border-left:1px solid var(--soft);
  width:var(--aside-width);
  box-shadow:var(--panel-shadow);
  position:relative;
  overflow-y:auto;
  padding:8px;
}
body.aside-collapsed aside{width:0;padding:0;border:none;}
.aside-tab{
  position:absolute;left:-22px;top:10px;width:22px;height:40px;
  display:flex;align-items:center;justify-content:center;
  background:var(--btn-bg);border:1px solid var(--btn-border);
  border-radius:6px 0 0 6px;cursor:pointer;box-shadow:var(--btn-hover-shadow);
  z-index:1000;
}

/* ===== „Éú„Éº„ÉâÈ†òÂüü ===== */
.board-wrap{
  order:1;position:relative;overflow:hidden;
  background:var(--panel-bg);
}
.board{width:100%;height:100%;touch-action:none;}

</style>
</head>
<body class="asideB-collapsed">
<header>
  <div class="title">ü¶õHippoly!</div>
  <div class="mid">
    <button id="snapHeader" title="ÁèæÂú®„ÅÆÁîªÈù¢„Çí„Çπ„Éä„ÉÉ„Éó">üì∏ „Çπ„Éä„ÉÉ„Éó</button>
  </div>
  <div style="position:absolute;right:12px;display:flex;gap:6px;">
    <button id="swapSidebars" title="Â∑¶Âè≥„ÅÆ„ÉÑ„Éº„É´„Éê„Éº„ÇíÂÖ•„ÇåÊõø„Åà">‚áÑ ÂÖ•„ÇåÊõø„Åà</button>
    <button id="themeToggle">üåô</button>
  </div>
</header>

<main>
  <!-- ‚ñº Â∑¶„ÉÑ„Éº„É´„Éê„Éº -->
  <aside class="asideB">
    <div class="asideB-tab" id="asideBTab" title="ÈñãÈñâ">‚ñ∂</div>
    <div class="panel-title">„Çπ„ÇØ„Ç∑„Éß</div>
    <div class="asideB-buttons">
      <button id="shot">üì∏ „Çπ„Éä„ÉÉ„Éó</button>
    </div>
    <div id="thumbList"></div>
    <div class="saveAllWrap">
      <button id="saveAll">‚¨á „Åô„Åπ„Å¶‰øùÂ≠ò</button>
    </div>
  </aside>

  <!-- ‚ñº ‰∏≠Â§Æ„Éú„Éº„Éâ -->
  <div class="board-wrap">
    <svg id="board" class="board"></svg>
    <canvas id="drawCanvas"></canvas>
    <canvas id="cursorCanvas"></canvas>
  </div>

  <!-- ‚ñº Âè≥„ÉÑ„Éº„É´„Éê„Éº -->
  <aside id="aside">
    <div class="aside-tab" id="asideTab" title="ÈñãÈñâ">‚óÄ</div>
    <div id="tools" class="toolbar">
      <!-- ÔºàÂè≥„ÉÑ„Éº„É´„Éê„Éº„ÅÆÂÜÖÂÆπ„ÅØ„ÅÇ„Å™„Åü„ÅÆÁèæË°å‰ªïÊßò„ÅÆ„Åæ„ÅæÔºâ -->
    </div>
  </aside>
</main>

<!-- „Éï„É´„Çπ„ÇØ„É™„Éº„É≥„Éì„É•„Éº„Ç¢ -->
<div id="lightbox">
  <button class="lb-close" id="lbClose">Èñâ„Åò„Çã</button>
  <div class="lb-nav lb-prev" id="lbPrev">‚Äπ</div>
  <img id="lbImg" alt="preview"/>
  <div class="lb-nav lb-next" id="lbNext">‚Ä∫</div>
</div>

<script>
const board=document.getElementById('board');
const drawCanvas=document.getElementById('drawCanvas');
const cursorCanvas=document.getElementById('cursorCanvas');
const ctx=drawCanvas.getContext('2d');
const cursorCtx=cursorCanvas.getContext('2d');

const state={
  tool:'edit',
  shapes:[],
  snaps:[],
  drawingPointerId:null
};

function resizeCanvas(){
  const rect=board.getBoundingClientRect();
  drawCanvas.width=cursorCanvas.width=rect.width;
  drawCanvas.height=cursorCanvas.height=rect.height;
}
window.addEventListener('resize',resizeCanvas);
resizeCanvas();

/* ========== Â∑¶„ÉÑ„Éº„É´„Éê„Éº ========== */
const uiB={
  aside:document.querySelector('.asideB'),
  tab:document.getElementById('asideBTab'),
  shot:document.getElementById('shot'),
  saveAll:document.getElementById('saveAll'),
  list:document.getElementById('thumbList'),
  lb:document.getElementById('lightbox'),
  lbImg:document.getElementById('lbImg'),
  lbPrev:document.getElementById('lbPrev'),
  lbNext:document.getElementById('lbNext'),
  lbClose:document.getElementById('lbClose'),
};
let lbIndex=0;

uiB.tab.addEventListener('click',()=>{
  document.body.classList.toggle('asideB-collapsed');
  uiB.tab.textContent=document.body.classList.contains('asideB-collapsed')?'‚ñ∂':'‚óÄ';
  resizeCanvas();
});

/* „Çπ„Éä„ÉÉ„ÉóÊíÆÂΩ± */
async function captureViewportPNG(){
  const svgEl=board;
  const {width:W,height:H}=svgEl.getBoundingClientRect();
  const xml=new XMLSerializer().serializeToString(svgEl);
  const svgBlob=new Blob([xml],{type:'image/svg+xml'});
  const svgURL=URL.createObjectURL(svgBlob);
  const img=await new Promise(res=>{
    const im=new Image();
    im.onload=()=>res(im);
    im.src=svgURL;
  });
  const c=document.createElement('canvas');
  c.width=W;c.height=H;
  const g=c.getContext('2d');
  g.fillStyle='#fff';g.fillRect(0,0,W,H);
  g.drawImage(img,0,0,W,H);
  g.drawImage(drawCanvas,0,0,W,H);
  URL.revokeObjectURL(svgURL);
  return c.toDataURL('image/png');
}

function addSnap(url){
  const id='snap_'+Date.now();
  state.snaps.push({id,dataURL:url});
  renderSnaps();
}
uiB.shot.addEventListener('click',async()=>{
  const url=await captureViewportPNG();
  addSnap(url);
});
document.getElementById('snapHeader').addEventListener('click',async()=>{
  const url=await captureViewportPNG();
  addSnap(url);
});

function renderSnaps(){
  uiB.list.innerHTML='';
  state.snaps.forEach((s,i)=>{
    const box=document.createElement('div');
    box.className='thumb';box.dataset.id=s.id;box.draggable=true;
    const cap=document.createElement('div');cap.className='cap';cap.textContent=i+1;
    const del=document.createElement('button');del.className='del';del.textContent='üóë';
    del.onclick=()=>{state.snaps=state.snaps.filter(x=>x.id!==s.id);renderSnaps();};
    const img=document.createElement('img');img.src=s.dataURL;
    img.onclick=()=>openLightbox(i);
    box.append(cap,del,img);

    // DnD ‰∏¶„ÅπÊõø„Åà
    box.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain',s.id);
      box.classList.add('dragging');
    });
    box.addEventListener('dragend',()=>box.classList.remove('dragging'));
    box.addEventListener('dragover',e=>{
      e.preventDefault();
      const draggingId=e.dataTransfer.getData('text/plain');
      if(!draggingId||draggingId===s.id)return;
      const from=state.snaps.findIndex(x=>x.id===draggingId);
      const to=i;
      if(from>=0&&to>=0&&from!==to){
        const [m]=state.snaps.splice(from,1);
        state.snaps.splice(to,0,m);
        renderSnaps();
      }
    });
    uiB.list.appendChild(box);
  });
}

async function saveAllSnaps(){
  for(let i=0;i<state.snaps.length;i++){
    const a=document.createElement('a');
    a.href=state.snaps[i].dataURL;
    a.download=`hippoly_${String(i+1).padStart(2,'0')}.png`;
    document.body.appendChild(a);a.click();a.remove();
    await new Promise(r=>setTimeout(r,100));
  }
}
uiB.saveAll.addEventListener('click',saveAllSnaps);

/* „É©„Ç§„Éà„Éú„ÉÉ„ÇØ„Çπ */
function openLightbox(i){
  lbIndex=i;uiB.lbImg.src=state.snaps[i].dataURL;uiB.lb.classList.add('show');
}
uiB.lbClose.onclick=()=>uiB.lb.classList.remove('show');
uiB.lbPrev.onclick=()=>{if(!state.snaps.length)return;lbIndex=(lbIndex-1+state.snaps.length)%state.snaps.length;uiB.lbImg.src=state.snaps[lbIndex].dataURL;};
uiB.lbNext.onclick=()=>{if(!state.snaps.length)return;lbIndex=(lbIndex+1)%state.snaps.length;uiB.lbImg.src=state.snaps[lbIndex].dataURL;};
uiB.lb.addEventListener('click',e=>{if(e.target===uiB.lb)uiB.lb.classList.remove('show');});
/* „Çπ„ÉØ„Ç§„ÉóÊìç‰Ωú */
(function(){
  let sx=0,sy=0;
  uiB.lb.addEventListener('touchstart',e=>{const t=e.touches[0];sx=t.clientX;sy=t.clientY;},{passive:true});
  uiB.lb.addEventListener('touchend',e=>{
    const t=e.changedTouches[0];const dx=t.clientX-sx,dy=t.clientY-sy;
    if(Math.abs(dx)>60&&Math.abs(dy)<80){dx<0?uiB.lbNext.onclick():uiB.lbPrev.onclick();}
  },{passive:true});
})();

/* Âè≥„ÉÑ„Éº„É´„Éê„ÉºÊ†ºÁ¥ç */
const aside=document.getElementById('aside');
const asideTab=document.getElementById('asideTab');
asideTab.onclick=()=>{
  document.body.classList.toggle('aside-collapsed');
  asideTab.textContent=document.body.classList.contains('aside-collapsed')?'‚ñ∂':'‚óÄ';
  resizeCanvas();
};

/* „Çµ„Ç§„Éâ„Éê„ÉºÂÖ•„ÇåÊõø„Åà */
document.getElementById('swapSidebars').onclick=()=>{
  document.body.classList.toggle('swap-sidebars');
  resizeCanvas();
};

/* ===== „ÉÜ„Éº„ÉûÂàáÊõøÔºàÁ∞°Áï•Ôºâ ===== */
const ui={themeToggle:document.getElementById('themeToggle')};
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme',theme);
  ui.themeToggle.textContent=(theme==='dark')?'‚òÄÔ∏è':'üåô';
  localStorage.setItem('board-theme',theme);
}
ui.themeToggle.onclick=()=>{
  const cur=document.documentElement.getAttribute('data-theme')||'light';
  applyTheme(cur==='light'?'dark':'light');
};
(function initTheme(){
  const saved=localStorage.getItem('board-theme');
  applyTheme(saved||((window.matchMedia('(prefers-color-scheme: dark)').matches)?'dark':'light'));
})();
</script>
</body>
</html>